---
layout: post
title: "[ì¸ì¦ê³¼ ì¸ê°€] - í† í° ê¸°ë°˜ ì¸ì¦ì„ í’€ìŠ¤íƒìœ¼ë¡œ êµ¬í˜„í•´ë³´ì (Next js, Typescript)"
author: Seobisback
tags: [Javascript, Typescript, React, NextJS, JWT, Login]
categories: Syntax
---

# HTTP í”„ë¡œí† ì½œì˜ íŠ¹ì„±

HTTP í”„ë¡œí† ì½œì€ stateless(ë¹„ìƒíƒœì„±) í•œ íŠ¹ì„±ì„ ê°–ëŠ”ë‹¤.

ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ ìƒíƒœë¥¼ ì €ì¥í•˜ì§€ ì•Šìœ¼ë©°, ì§ì „ì— ì§„í–‰í•œ í†µì‹ ì— ê´€í•´ ê¸°ì–µí•˜ì§€ ì•ŠëŠ”ë‹¤.

![Untitled](/assets/images/posts/2024-03-06-jwttoken/jwttoken01.png)

ë”°ë¼ì„œ HTTPëŠ” ìš”ì²­í•œ í´ë¼ì´ì–¸íŠ¸ê°€ ì´ì „ì— ì–´ë– í•œ ì¸ì¦ ê³¼ì • (ë¡œê·¸ì¸ ë“±ì„ ì§„í–‰í•˜ì˜€ëŠ”ê°€?) ì„ ê±°ì³¤ëŠ”ì§€ ì•Œ ìˆ˜ê°€ ì—†ë‹¤.

ê·¸ë ‡ë‹¤ê³  ë§¤ ìˆœê°„ ë¡œê·¸ì¸ì´ í•„ìš”í•œ ìš”ì²­ í˜¸ì¶œì— ìœ ì €ì—ê²Œ ë¡œê·¸ì¸ì„ í•´ë‹¬ë¼ê³  ìš”êµ¬í•˜ëŠ” ê²ƒì€ UXë¥¼ ì „í˜€ ê³ ë ¤í•˜ì§€ ì•ŠëŠ” ë°©ì‹ì´ë‹¤.

ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ìœ„ì˜ ë¬¸ì œì ì„ í•´ê²°í•˜ê¸° ìœ„í•´  `ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦ê³¼ í† í° ê¸°ë°˜ ì¸ì¦` ì´ë¼ëŠ” ê¸°ìˆ ì„ í†µí•´ í•´ê²°í•œë‹¤.

ì´ ê¸€ì€ `í† í° ê¸°ë°˜ ì¸ì¦` ì„ A to Z ê¹Œì§€ `í”„ë¡ íŠ¸ì—”ë“œ` ì™€ `ë°±ì—”ë“œ` ë¥¼ ë™ì‹œì— êµ¬í˜„í•´ë³´ë©° flowì™€ êµ¬í˜„ ë°©ë²•ì„ ì´í•´í•´ ë³´ëŠ” ê²ƒì„ íšŒê³ í•œ ê¸€ì´ë‹¤.

# í† í° ê¸°ë°˜ ì¸ì¦

- í† í° ê¸°ë°˜ ì¸ì¦ì€ ì¸ì¦ ì •ë³´ë¥¼ í´ë¼ì´ì–¸íŠ¸ê°€ ì§ì ‘ ê°€ì§€ê³  ìˆë‹¤. (ì´ë•Œ ì¸ì¦ ì •ë³´ëŠ” í† í°ì˜ í˜•íƒœë¡œ ë¸Œë¼ìš°ì €ì˜ LocalStorage ë° Cookie ì— ì €ì¥í•œë‹¤)
- í† í°ì˜ ì¢…ë¥˜ì— ë”°ë¼ ë‹¤ë¥´ê² ì§€ë§Œ, ëŒ€í‘œì ì¸ í† í°ì¸ JWTì˜ ê²½ìš° ë””ì§€í„¸ ì„œëª…ì´ ì¡´ì¬í•˜ë¯€ë¡œ í† í°ì´ ìœ„ë³€ì¡° ë’¤ì—ˆëŠ”ì§€ ì„œë²„ ì¸¡ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
- í† í° ê¸°ë°˜ ì¸ì¦ì—ì„œëŠ” ì‚¬ìš©ìê°€ ê°€ì§€ê³  ìˆëŠ” í† í°ì„ HTTPì˜ Authorization í—¤ë”ì— ì‹¤ì–´ ë³´ë‚¸ë‹¤.
- í•´ë‹¹ í—¤ë”ë¥¼ ìˆ˜ì‹ í•œ ì„œë²„ëŠ” í† í°ì´ ìœ„ë³€ì¡° ë˜ì—ˆê±°ë‚˜, ë§Œë£Œ ì‹œê°ì´ ì§€ë‚˜ì§€ ì•Šì€ì§€ í™•ì¸í•œ ì´í›„ í† í°ì— ë‹´ê²¨ìˆëŠ” ì‚¬ìš©ì ì¸ì¦ ì •ë³´ë¥¼ í™•ì¸í•´ ì‚¬ìš©ìë¥¼ ì¸ê°€í•œë‹¤.

---

# êµ¬í˜„ ì‹œì‘ ì „ì—

## ì–´ë–»ê²Œ êµ¬í˜„í• ê¹Œ?

ì¼ë‹¨ í•„ìëŠ” í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œë¥¼ ê°™ì´ êµ¬í˜„í•˜ë©° ì§„í–‰í•  ê²ƒì´ë‹¤.

ì¸ì¦ê³¼ ì¸ê°€ì— ê´€ë ¨ëœ ê¸°ëŠ¥ì´ë‹ˆ ë¡œê·¸ì¸ê³¼ íšŒì›ê°€ì… ê·¸ë¦¬ê³  í† í° ë§Œë£Œ ì‹œ ë¦¬í”„ë ˆì‹œ ë“±ì„ êµ¬í˜„í•  ìƒê°ì´ë‹¤.

í•„ìš”í•œ ì¬ë£Œë¥¼ ìƒê°í•´ë³¸ë‹¤ë©´ ê°„ë‹¨í•œ DBë„ ì„¤ê³„í•´ì•¼ í•œë‹¤.

ìŠ¤í„°ë””ìš© í† ì´ í”„ë¡œì íŠ¸ë‹ˆê¹Œ ë””ìì¸ì€ ì‹ ê²½ì“°ì§€ ì•Šê³  ê¸°ëŠ¥ì—ë§Œ ì§‘ì¤‘í•´ë³´ì.

## ì§„í–‰ ì „ ê¸°ìˆ  ìŠ¤í™ ëª…ì„¸

### Server

ì„œë²„ëŠ” ë¡œì»¬ì—ì„œ ì§„í–‰í•´ë„ ë˜ì§€ë§Œ ë†€ê³  ìˆëŠ” EC2 ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆê¸° ë•Œë¬¸ì— ì´ë²ˆ ê¸°íšŒì— ì¡°ê¸ˆì´ë¼ë„ ì¼ì„ ì‹œì¼œë³¼ ìƒê°ì´ë‹¤.

![Untitled](/assets/images/posts/2024-03-06-jwttoken/jwttoken02.png)

### Database

ì„¤ì¹˜í•´ì„œ ê°„ë‹¨í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥í•œ MySQL ì„ EC2ì— ì„¤ì¹˜í•´ì„œ ì‚¬ìš©í•˜ê¸°ë¡œ í–ˆë‹¤.

### Front-end & Back-end

ë†€ê³  ìˆëŠ” EC2ì— ë§Œë“¤ì—ˆë˜ Next JS í”„ë¡œì íŠ¸ê°€ ìˆë‹¤.

í…ŒìŠ¤íŠ¸ìš© í˜ì´ì§€ë‘ APIë¥¼ êµ¬í˜„í•˜ëŠë¼ ë§Œë“¤ì—ˆëŠ”ë° ë†€ê³  ìˆìœ¼ë‹ˆê¹Œ ì´ ì¹œêµ¬ë¥¼ í™œìš©í•´ë³´ê² ë‹¤.

ë¤ìœ¼ë¡œ Next APIë¥¼ ì‚¬ìš©í•˜ë©´ API ì„œë²„ê¹Œì§€ êµ¬í˜„í•  í•„ìš” ì—†ìœ¼ë‹ˆ ì´ˆê¸° ì„¸íŒ…ì´ ì¤„ì–´ì„œ ê¸°ë¶„ì´ ì¢‹ì•„ì§„ë‹¤.

ê·¸ë¦¬ê³  íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìœ¼ë©´ ì‚´ ìˆ˜ ì—†ëŠ” ëª¸ì´ ë˜ì–´ì„œ íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ë„ ì‚¬ìš©í•˜ê² ë‹¤.

Package.json

```jsx
{
  "name": "my-next-app",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@tanstack/react-query": "^5.22.2",
    "crypto": "^1.0.1",
    "jsonwebtoken": "^9.0.2",
    "mysql": "^2.18.1",
    "mysql2": "^3.9.1",
    "next": "14.0.4",
    "nodemailer": "^6.9.9",
    "react": "^18",
    "react-dom": "^18"
  },
  "devDependencies": {
    "@types/jsonwebtoken": "^9.0.5",
    "@types/mysql": "^2.15.25",
    "@types/node": "^20",
    "@types/nodemailer": "^6.4.14",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "eslint": "^8",
    "eslint-config-next": "14.0.4",
    "typescript": "^5"
  }
}

```

## ê°„ë‹¨í•œ DB ì„¤ê³„

ERD ì„¤ê³„í•´ì„œ ê³µìœ í•˜ê±°ë‚˜ í•  ë•Œ í¸í•œ ì‚¬ì´íŠ¸ë¥¼ ì´ìš©í•´ë³´ì•˜ë‹¤.

ë‚˜ë„ ì§€ì¸í•œí…Œ ì¶”ì²œì„ ë°›ì•˜ìœ¼ë‹ˆ ì‚¬ìš©í•´ë³´ì‹œê³  ì…ë§›ì— ë§ìœ¼ë©´ ì¨ë³´ëŠ”ê±° ì¶”ì²œ ë“œë¦°ë‹¤.

https://dbdiagram.io/

![Untitled](/assets/images/posts/2024-03-06-jwttoken/jwttoken03.png)

ê°„ë‹¨í•˜ê²Œ ë§Œë“¤ì–´ë³¸ ERDì´ë‹¤.

ì„¤ëª…ì„ ì¡°ê¸ˆ í•´ë³´ìë©´ `users` í…Œì´ë¸” ì™¸ì—ëŠ” í˜„ì¬ ê¸€ê³¼ëŠ” ë¬´ê´€í•œ ë‚´ìš©ì´ë¯€ë¡œ ë¬´ì‹œí•´ë„ ìƒê´€ì—†ë‹¤.

`users` í…Œì´ë¸” ë‚´ë¶€ì— ì €ì¥í•  ìœ ì € ì •ë³´ë“¤ê³¼ í† í° êµ¬í˜„ í›„ì— ì €ì¥í•´ ì¤„ refresh_token í•„ë“œë¥¼ ë§Œë“¤ì—ˆë‹¤.

### í† í° ê¸°ë°˜ ì¸ì¦ êµ¬í˜„ í”Œë¡œìš°

![Untitled](/assets/images/posts/2024-03-06-jwttoken/jwttoken04.png)

ì´ë¯¸ì§€ ì¶œì²˜ : https://www.bezkoder.com/jwt-refresh-token-node-js/

í•´ë‹¹ ì´ë¯¸ì§€ê°€ í† í° ê¸°ë°˜ ì¸ì¦ í”Œë¡œìš°ë¥¼ ì •ë§ ì˜ ì„¤ëª…í•œ ì´ë¯¸ì§€ë¼ ìƒê°í•´ì„œ ì²¨ë¶€í•´ë³´ì•˜ë‹¤.

í•˜ë‚˜í•˜ë‚˜ ë²ˆí˜¸ë¡œ í’€ì´ í•´ë³´ìë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

[ìœ ì €ê°€ ë¡œê·¸ì¸ í•  ê²½ìš° - Create Token]

1. Client ì—ì„œ ìœ ì €ê°€ ë¡œê·¸ì¸ ìš”ì²­ì„ í•  ê²½ìš° APIì´ë‹¤.
1. ServerëŠ” Clientì—ì„œ ì „ë‹¬ ë°›ì€ ì •ë³´ë¥¼ ê°€ì§€ê³  JWT í† í°ì„ ìƒì„±í•œë‹¤.
1. ServerëŠ” ìƒì„±ëœ JWT í† í°ê³¼ Clientì— ì „ë‹¬í•  ìœ ì € ì •ë³´ë¥¼ ë‹´ì•„ì„œ Clientì— ì „ë‹¬í•œë‹¤.

[í† í° ê¸°ê°„ì´ ë§Œë£Œë  ê²½ìš° - Expired Token]

1. ClientëŠ” ì¸ì¦ì´ í•„ìš”í•œ API Request ë§ˆë‹¤ HTTP Headerì— AccessTokenì„ ë‹´ì•„ì„œ ìš”ì²­í•˜ê²Œ ëœë‹¤.
1. ServerëŠ” Clientê°€ ì „ë‹¬í•œ í† í°ì„ í•­ìƒ ë§Œë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë¡œì§ì„ ê±°ì¹˜ê³ , í† í° ê¸°ê°„ì´ ë§Œë£Œë˜ì—ˆë‹¤ë©´ Clientì— Tokenì´ ë§Œë£Œë˜ì—ˆìŒì„ ì•Œë¦¬ëŠ” Responseë¥¼ ì „ë‹¬í•œë‹¤.
1. ClientëŠ” Serverë¡œ ë¶€í„° Tokenì´ ë§Œë£Œë˜ì—ˆìŒì„ ì „ë‹¬ ë°›ëŠ”ë‹¤.

[í† í° ê¸°ê°„ ë§Œë£Œ ì´í›„ í† í° Refresh]

1. 6ë²ˆì—ì„œ ì „ë‹¬ ë°›ì€ Reponse ì •ë³´ë¥¼ í† ëŒ€ë¡œ ClientëŠ” AccessTokenì´ ë§Œë£Œë˜ì—ˆìŒì„ ì•Œê²Œ ë˜ê³  RefreshToken ì„ Serverì— ì „ë‹¬í•˜ë©´ì„œ ìƒˆë¡œìš´ AccessTokenì„ ë°œê¸‰í•´ë‹¬ë¼ëŠ” ìš”ì²­ì„ í•˜ê²Œ ëœë‹¤.
1. ServerëŠ” ì „ë‹¬ ë°›ì€ RefreshToken ì„ ê²€ì¦í•˜ëŠ” ì ˆì°¨ë¥¼ ê±°ì¹œë‹¤. (í† í° ê¸°ê°„ì´ ë§Œë£Œë˜ì—ˆëŠ”ê°€? í˜¹ì€ í† í°ì´ ìœ„ë³€ì¡° ë˜ì§€ëŠ” ì•Šì•˜ëŠ”ê°€?) ê·¸ í›„ ì„œë²„ëŠ” ìƒˆë¡œìš´ AccessToken ì„ ìƒì„±í•˜ì—¬ Clientì—ê²Œ ì „ë‹¬í•˜ê²Œ ëœë‹¤.
1. ClientëŠ” ìˆ˜ì‹  ë°›ì€ ìƒˆë¡œìš´ AccessTokenê³¼ RefreshToken ì •ë³´ë¥¼ ë‹¤ì‹œ ì €ì¥í•œë‹¤.

---

# ë¡œê·¸ì¸ êµ¬í˜„ ì‹œì‘ ( í† í° ê¸°ë°˜ ì¸ì¦ í”Œë¡œìš° 1 ~ 3 ë²ˆ)

### JWT ìƒì„± ë° ê²€ì¦ ëª¨ë“ˆ êµ¬í˜„ (Back-end)

File Name : jsonwebtoken.ts

- `fs` ëª¨ë“ˆì„ ì‚¬ìš©í•´ì„œ ìƒì„±í•´ë‘” ë¹„ë°€í‚¤ì™€ ê³µê°œí‚¤ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  `jsonwebtoken` ëª¨ë“ˆì„ ì‚¬ìš©í•´ì„œ í† í°ì„ ë§Œë“¤ê±°ë‚˜ ê²€ì¦í•œë‹¤.
- RefreshTokenì˜ ê²½ìš° ë³´í†µ AccessTokenë³´ë‹¤ ìƒëª… ì£¼ê¸°ê°€ ê¸¸ê³ , AccessTokenì€ ìƒëª… ì£¼ê¸°ê°€ ì§§ë‹¤. ì´ ë¶€ë¶„ì€ í† í°ì´ íƒˆì·¨ ë‹¹í–ˆì„ ì‹œ ë³´ì•ˆì— ê´€ê³„ë˜ëŠ” ë¶€ë¶„ì´ë‹¤.

```tsx
import fs from 'fs';

export const createAccessToken = (userId: string) => {
    const privateKey = fs.readFileSync('private.key', 'utf-8');
    const jwt = require('jsonwebtoken');
    const accessToken = jwt.sign({ userId: userId }, privateKey, {
        algorithm: 'RS256',
        expiresIn: '1h',
        // expiresIn: '3000', // test (3000ms)
    });

    return accessToken;
}

export const verifyAccessToken = (accessToken: string) => {
    const publicKey = fs.readFileSync('public.key', 'utf-8');
    const jwt = require('jsonwebtoken');
    try {
        const verified = jwt.verify(accessToken, publicKey)
        return verified;
    } catch (error) {
        throw error
    }
}

export const createRefreshToken = (userId: string) => {
    const privateKey = fs.readFileSync('private.key', 'utf-8');
    const jwt = require('jsonwebtoken');
    const refreshToken = jwt.sign({ userId: userId}, privateKey, {
        algorithm: 'RS256',
        expiresIn: '7d',
    });

    return refreshToken;
}

export const verifyRefreshToken = (refreshToken: string) => {
    const publicKey = fs.readFileSync('public.key', 'utf-8');
    const jwt = require('jsonwebtoken');
    try {
        const verified = jwt.verify(refreshToken, publicKey)
        return verified;
    } catch (error) {
        throw error
    }
}
```

### ë¡œê·¸ì¸ API êµ¬í˜„ (Back-end)

File Name : loginUser.ts

- NextApiëŠ” ì •ë§ í¸í•˜ë‹¤ êµ³ì´ API ì„œë²„ë¥¼ ë§Œë“¤ í•„ìš” ì—†ìœ¼ë‹ˆ ë§ì´ë‹¤.
- Next apiì˜ endpointëŠ” `api` í´ë” ì•„ë˜ì—ì„œ ìƒì„±í•œ íŒŒì¼ ì´ë¦„ê³¼ ë””ë ‰í† ë¦¬ ì´ë¦„ì— ì˜í–¥ì„ ë°›ìœ¼ë¯€ë¡œ ì ë‹¹í•˜ê²Œ ìƒì„±í•˜ê¸¸ ë°”ë€ë‹¤. (í•„ìëŠ” api/loginUser.ts ê²½ë¡œì— ìƒì„±)
- APIì— ê´€í•œ ì„¤ëª…

```tsx
// Next.js API route support: https://nextjs.org/docs/api-routes/introduction
import type { NextApiRequest, NextApiResponse } from 'next'
import { handleMySQLQuery } from '@/db/dbConn';
import { createAccessToken, createRefreshToken } from '@/utils/jsonwebtoken';
type Data = {
    status: string,
    code: number,
    message: string,
    result?: {
        accessToken : string,
        refreshToken : string,
        userInfo : {
          userId: string,
          username: string,
          role: string,
          create_at: string,
        }
    }
}

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse<Data>
) {
  try {
    let findUserInfoResult = await handleMySQLQuery({
      sqlStr: `SELECT * FROM TestDB.users WHERE user_id='${req.body.userId}';`
    });
    
    let userData = {
      userId: '',
      username: '',
      role: '',
      createAt: '',
    }

    if(findUserInfoResult && Array.isArray(findUserInfoResult) && findUserInfoResult.length !== 0){
      if(findUserInfoResult[0].password !== req.body.password){
        res.status(422).json({
          status: 'Unprocessable Content',
          code: 422,
          message: 'Password Wrong'
        });
      }

      userData.userId = findUserInfoResult[0].user_id;
      userData.username = findUserInfoResult[0].username;
      userData.role = findUserInfoResult[0].role;
      userData.createAt = findUserInfoResult[0].create_at;
      
    } else {
      res.status(401).json({
        status: 'Unauthorized',
        code: 401,
        message: 'UserId is not defined'
      });
    }

    const accessToken = createAccessToken(req.body.userId);
    const refreshToken = createRefreshToken(req.body.userId);

    let updateRefreshTokenResult = await handleMySQLQuery({
      sqlStr: `UPDATE TestDB.users SET refresh_token='${refreshToken}' WHERE user_id='${req.body.userId}'`
    })

    res.status(200).json({
      status: 'Success',
      code: 200,
      message: 'Login Success',
      result: {
        accessToken,
        refreshToken,
        userInfo:{
          userId: userData.userId,
          username: userData.username,
          role: userData.role,
          create_at: userData.createAt,
        }
      }
    });
  } catch (error) {
    console.error(error)

    res.status(500).json({
      status: 'Failed',
      code: 500,
      message: 'Server Error'
    });
  }
}
```

### ë¡œê·¸ì¸ ê¸°ëŠ¥ êµ¬í˜„ (Front-end)

File Name : LoginUserForm.tsx

- ê°„ë‹¨í•œ ìœ ì €ì˜ ë¡œê·¸ì¸ í¼ ì»´í¬ë„ŒíŠ¸ë¥¼ ë§Œë“¤ì—ˆë‹¤.
- React Queryì˜ useMutationì„ ì‚¬ìš©í•´ APIë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì½”ë“œë¥¼ ë§Œë“¤ì–´ë³´ì•˜ë‹¤.
- ìœ„ì—ì„œ ìƒì„±í•œ APIë¥¼ í† ëŒ€ë¡œ í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œë¥¼ êµ¬í˜„í•´ë³´ì

```tsx
'use client';
import React, { useState } from "react";
import styles from './LoginUserForm.module.css';
import { useMutation } from "@tanstack/react-query";
import postLoginUser from "@/queries/postLoginUser";

const ACCESS_TOKEN_STORAGE_KEY = 'AccessToken';
const REFRESH_TOKEN_STORAGE_KEY = 'RefreshToken';

function LoginUserForm(){
    const [idVal, setIdVal] = useState('');
    const [pwVal, setPwVal] = useState('');
    const {mutate: loginUser} = useMutation({
        mutationFn: postLoginUser,
        onError: (error) => {
            console.log(error)

            alert('ë¡œê·¸ì¸ ì‹¤íŒ¨');
        },
        onSuccess: (data) => {
            if(data.code === 200){
                const {accessToken, refreshToken} = data.result;

                setIdVal('');
                setPwVal('');
                
                localStorage.setItem(ACCESS_TOKEN_STORAGE_KEY, accessToken)
                localStorage.setItem(REFRESH_TOKEN_STORAGE_KEY, refreshToken)

                alert('ë¡œê·¸ì¸ ì™„ë£Œ');
            } else if(data.code === 401){
                setIdVal('');
                setPwVal('');
                alert('ì•„ì´ë””ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ');
            } else if(data.code === 422){
                setPwVal('');
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦¼');
            } else {
                alert('ë¡œê·¸ì¸ ì‹¤íŒ¨');
            }
        }
    })

    const loginBtnClickHandler = (event: React.MouseEvent<HTMLButtonElement>) => {
        event.preventDefault();
        
        loginUser({
            userId: idVal,
            password: pwVal,
        })
    }
    
    const logoutBtnClickHandler = (event: React.MouseEvent<HTMLButtonElement>) => {
        event.preventDefault();

        localStorage.removeItem(ACCESS_TOKEN_STORAGE_KEY)
        localStorage.removeItem(REFRESH_TOKEN_STORAGE_KEY)

        alert('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
    }

    return(
        <div className={styles.login_user_form_root}>
            <input 
                onChange={(event: React.ChangeEvent<HTMLInputElement>) => {setIdVal(event.target.value)}} 
                placeholder="ì•„ì´ë””"  
                value={idVal}/>
            <input 
                onChange={(event: React.ChangeEvent<HTMLInputElement>) => {setPwVal(event.target.value)}} 
                placeholder="ë¹„ë°€ë²ˆí˜¸" 
                value={pwVal}/>
            <button onClick={loginBtnClickHandler}>ë¡œê·¸ì¸</button>
            <button onClick={logoutBtnClickHandler}>ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    )
}

export default LoginUserForm
```

File Name : postLoginUser.ts

- Data Fetchingì— ì‚¬ìš©ë˜ëŠ” í•¨ìˆ˜ì´ë‹¤.
- useMutationì˜ Fetch í•¨ìˆ˜ ì—­í• ì„ í•  ê²ƒì´ë‹¤.
- ê¸°ë³¸ fetch apië¥¼ ì‚¬ìš©í•˜ì˜€ë‹¤.
- apiì˜ end pointëŠ” ìœ„ì— NextAPI ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ë©´ëœë‹¤. (ì•„ì£¼ í¸í•˜ë‹¤)

```tsx

type Tparams= {
    userId: string,
    password: string,
}

async function postLoginUser({userId, password}: Tparams){
    let data = {
        userId: userId,
        password: password,
    }

    const response = await fetch(`/api/loginUser`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    });

    return response.json();
}

export default postLoginUser;
```

> ì´ë ‡ê²Œ Front-endì™€ Back-endì—ì„œ ê°„ë‹¨í•œ í† í° ê¸°ë°˜ ì¸ì¦ ë¡œê·¸ì¸ êµ¬í˜„ì´ ëë‚¬ë‹¤.
>ìœ„ì—ì„œ ì„¤ëª…í•œ í† í° ê¸°ë°˜ ì¸ì¦ í”Œë¡œìš°ì˜ 1 ~ 3 ê¹Œì§€ë¥¼ êµ¬í˜„í•œ ê²ƒì´ë‹¤.
>
>ë°•ìˆ˜ ğŸ‘
> 

---

# AccessTokenì˜ ë§Œë£Œ ( í† í° ê¸°ë°˜ ì¸ì¦ í”Œë¡œìš° 4 ~ 9 ë²ˆ)

### í† í° ì²´í¬ ë° ìƒˆë¡œìš´ í† í° ë°œê¸‰ API êµ¬í˜„ (Back-end)

File Name : tokenCheck.ts

- `jsonwebtoken.ts` íŒŒì¼ì— ë§Œë“¤ì–´ë‘” í•¨ìˆ˜ ì¤‘ `verifyAccessToken` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ë³´ê² ë‹¤.
- ì´ APIëŠ” ì „ë‹¬ ë°›ì€ AccessTokenì´ ìœ íš¨í•œ ìƒíƒœì¸ì§€ íŒë‹¨í•˜ê³  í•´ë‹¹ ê²°ê³¼ë¥¼ Clientì—ê²Œ ì „í•´ì¤€ë‹¤.

```tsx
// Next.js API route support: https://nextjs.org/docs/api-routes/introduction
import type { NextApiRequest, NextApiResponse } from 'next'
import { verifyAccessToken } from '@/utils/jsonwebtoken';
import jwt from 'jsonwebtoken';
type Data = {
    status: string,
    code: number,
    message: string,
    result?: {
        accessToken : string,
        refreshToken : string,
    }
}

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse<Data>
) {
  try {
    let verifyResult;
    if(req.headers.authorization){
        const token = req.headers.authorization.split(' ')[1];
        verifyResult = verifyAccessToken(token);
    } else {
      res.status(401).json({
        status: 'Unauthorized',
        code: 401,
        message: 'jwt is not defined'
      });
    }

    res.status(200).json({
      status: 'Success',
      code: 200,
      message: 'jwt is fresh'
    });

  } catch (error) {
    console.error(error)

    if(error instanceof jwt.TokenExpiredError){
        res.status(401).json({
          status: 'Unauthorized',
          code: 401,
          message: 'jwt expired'
        });
    }

    if(error instanceof jwt.JsonWebTokenError){
      res.status(401).json({
        status: 'Unauthorized',
        code: 401,
        message: 'jwt is not valid'
      });
    }

    res.status(500).json({
      status: 'Failed',
      code: 500,
      message: 'Server Error'
    });
  }
}
```

File Name : refreshtoken.ts

- Client ì—ê²Œì„œ ì „ë‹¬ë°›ì€ Refresh Tokenì„ í† ëŒ€ë¡œ AccessTokenì„ ìƒˆë¡œ ë°œê¸‰í•´ì£¼ëŠ” API

```tsx
// Next.js API route support: https://nextjs.org/docs/api-routes/introduction
import type { NextApiRequest, NextApiResponse } from 'next'
import { verifyRefreshToken, createAccessToken } from '@/utils/jsonwebtoken';
import { handleMySQLQuery } from '@/db/dbConn';
import jwt from 'jsonwebtoken';
type Tdata = {
    status: string,
    code: number,
    message: string,
    result?: {
        accessToken : string,
    }
}

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse<Tdata>
) {
  try {
    let refreshToken = req.body.refreshToken;
    let verifyResult;
    let newAccessToken;
    if(refreshToken){
        verifyResult = verifyRefreshToken(refreshToken);
        if(verifyResult && verifyResult.userId){
          let userInfo = await handleMySQLQuery({
            sqlStr: `SELECT refresh_token FROM TestDB.users WHERE user_id='${verifyResult.userId}'`
          })

          if(Array.isArray(userInfo) && userInfo[0].refresh_token === refreshToken){
            newAccessToken = createAccessToken(verifyResult.userId);
          } else {
            res.status(401).json({
              status: 'Unauthorized',
              code: 401,
              message: 'refreshtoken is not valid'
            });
          }
        }
    }
    if(newAccessToken){
      res.status(200).json({
        status: 'Success',
        code: 200,
        message: 'accessToken refreshed',
        result: {
          accessToken: newAccessToken,
        }
      });
    } else {
      throw new Error();
    }
  } catch (error) {
    console.error(error)
    if(error instanceof jwt.TokenExpiredError){
        res.status(401).json({
          status: 'Unauthorized',
          code: 401,
          message: 'refreshtoken expired'
        });
    }

    res.status(500).json({
      status: 'Failed',
      code: 500,
      message: 'Server Error'
    });
  }
}
```

### í† í° ê²€ì¦ì„ ìœ„í•œ Custom Hook êµ¬í˜„ (Front-end)

File Name : useAuth.ts

- AccessToken ì²´í¬ë¥¼ ìš”ì²­í•˜ëŠ” ì½”ë“œì™€ AccessToken ì„ refresh ìš”ì²­í•˜ëŠ” ì½”ë“œë¥¼ React Hook ìœ¼ë¡œ êµ¬í˜„í•˜ì˜€ë‹¤.

```tsx
import React from 'react';
import { useMutation } from '@tanstack/react-query';
import getTokenCheck from '@/queries/getTokenCheck';
import postRefreshToken from '@/queries/postRefreshToken';

const ACCESS_TOKEN_STORAGE_KEY = 'AccessToken';
const REFRESH_TOKEN_STORAGE_KEY = 'RefreshToken';

type TresponseData = {
    code: number,
    message: string,
    result?: {
        accessToken: string
    },
    status: string,
}

function useAuth(){
    const {mutate: checkAccessToken} = useMutation({
        mutationFn: getTokenCheck,
        onSuccess: (data: TresponseData) => {
            console.log('data ', data);
            if(data.code === 401){
                // AccessTokenì´ ë§Œë£Œë˜ì—ˆìœ¼ë¯€ë¡œ RefreshTokenìœ¼ë¡œ AccessToken ì¬ë°œê¸‰ ìš”ì²­
                refreshAccessToken();
            }
        },
        onError: (error) => {
            console.log(error);
        }
    })

    const {mutate: reqPostRefreshToken} = useMutation({
        mutationFn: postRefreshToken,
        onSuccess: (data: TresponseData) => {
            console.log(data)
            if(data.code === 200 && data.result){
                localStorage.setItem(ACCESS_TOKEN_STORAGE_KEY, data.result.accessToken);
                console.log('refreshed access token');
            }

            if(data.code === 401){
                // Refresh Tokenì´ ë§Œë£Œë˜ì—ˆìœ¼ë¯€ë¡œ ë‹¤ì‹œ ë¡œê·¸ì¸ ìš”ì²­
                localStorage.removeItem(ACCESS_TOKEN_STORAGE_KEY);
                localStorage.removeItem(REFRESH_TOKEN_STORAGE_KEY);
                alert('Refresh Token expired, please login again');
            }
        },
        onError: (error) => {
            console.error(error);
        }
    })

    const validationAccessToken = () => {
        const accessToken = localStorage.getItem(ACCESS_TOKEN_STORAGE_KEY);

        if(accessToken){
            checkAccessToken({accessToken: accessToken})
        }
    }

    const refreshAccessToken = () => {
        const refreshToken = localStorage.getItem(REFRESH_TOKEN_STORAGE_KEY);

        if(refreshToken){
            reqPostRefreshToken({refreshToken})
        } else {
            localStorage.removeItem(ACCESS_TOKEN_STORAGE_KEY);
            localStorage.removeItem(REFRESH_TOKEN_STORAGE_KEY);
        }
    }

    return {
        validationAccessToken,
        refreshAccessToken
    }
}

export default useAuth;
```

File Name : getTokenCheck.ts

- í† í° ê²€ì¦ì„ ìš”ì²­í•˜ê³  ìœ„ì—ì„œ ì‘ì„±í•œ ì»¤ìŠ¤í…€ í›…ì— ì‚¬ìš©ë˜ëŠ” fetch í•¨ìˆ˜ì´ë‹¤.

```tsx

type Tparams = {
    accessToken: string,
}

async function getTokenCheck({accessToken}: Tparams){
    const response = await fetch(`/api/tokenCheck`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json',
        }
    });

    return response.json();
}

export default getTokenCheck;
```

File Name : postRefreshToken.ts

- ë§Œë£Œëœ AccessTokenì„ ìƒˆë¡œ ë°œê¸‰ ìš”ì²­í•˜ë©° ìœ„ì—ì„œ ì‘ì„±í•œ ì»¤ìŠ¤í…€ í›…ì— ì‚¬ìš©ë˜ëŠ” fetch í•¨ìˆ˜ì´ë‹¤.

```tsx

type Tprams = {
    refreshToken: string
}

async function postRefreshToken({refreshToken}: Tprams){
    let data = {
        refreshToken
    }

    const response = await fetch(`/api/refreshtoken`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    });

    return response.json();
}

export default postRefreshToken;
```

> ì´ë ‡ê²Œ Front-endì™€ Back-endì—ì„œ AccessTokenì˜ ë§Œë£Œ ì²´í¬ì™€ ë§Œë£Œ ì‹œ Refresh í•´ì£¼ëŠ” êµ¬í˜„ê¹Œì§€ ëì´ ë‚¬ë‹¤.
>
>ìœ„ì—ì„œ ì„¤ëª…í•œ í† í° ê¸°ë°˜ ì¸ì¦ í”Œë¡œìš°ì˜ 4 ~ 9 ê¹Œì§€ë¥¼ êµ¬í˜„í•œ ê²ƒì´ë‹¤.
>
>í˜¹ì‹œ í—·ê°ˆë¦´ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì°¨ê·¼ì°¨ê·¼ í’€ì–´ì„œ ì„¤ëª…í•´ë³´ìë©´
>
>1. ì¸ì¦ì´ í•„ìš”í•œ API Request ì‹œ `useAuth` í›…ì„ í†µí•´ `validationAccessToken` í•¨ìˆ˜ë¥¼ íƒ€ê³  `tokenCheck API` ì— AccessToken ë§Œë£Œ ì²´í¬ë¥¼ >ìš”ì²­í•˜ê²Œ ëœë‹¤.
>2. ë§Œì•½ AccessTokenì´ ë§Œë£Œë˜ì—ˆë‹¤ë©´ `refreshtoken API` ì— Refresh Tokenì„ ì£¼ë©° AccessTokenì„ ìƒˆë¡œ ë°œê¸‰í•´ë‹¬ë¼ëŠ” ìš”ì²­ì„ ì§„í–‰í•œë‹¤.
>3. ìƒˆë¡œìš´ AccessTokenì´ ë°œê¸‰ë˜ë©´ í•´ë‹¹ í† í°ì„ ë‹¤ì‹œ Clientì— ì €ì¥í•˜ê³  ì‚¬ìš©í•˜ë©´ ëœë‹¤.
> 

ì¸ì¦ ê´€ë ¨ ë¶€ë¶„ì€ í•­ìƒ í—·ê°ˆë¦¬ê³  ì–´ë ¤ìš´ ë¶€ë¶„ì´ ë§ì€ ë§Œí¼ ê°„ë‹¨í•˜ê²Œ ë‚˜ë§ˆ êµ¬í˜„ì„ í•˜ë©° ì •ë¦¬í•´ë³´ì•˜ë‹¤.